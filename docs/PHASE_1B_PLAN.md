# Phase 1B: User Accounts & Deck Publishing

## Overview
Enable users to publish decks to Supabase with automated hosting, moderation, and classification.

## Key Features

### 1. Authentication
- Supabase Auth (email/password)
- Sign up / Sign in flows
- Session management

### 2. Image Hosting
- Automatic upload to Vercel Blob on publish
- Images stored permanently on our servers
- No more manual migration friction
- **Critical for adoption!**

### 3. Content Moderation & Classification

#### Three-Stage Moderation (Cost-Optimized):

**Stage 1: Text Analysis (~0.01 NOK)**
- Moderation (block/warn/allow)
- Classification (category, tags, themes)
- Quality scoring (0-10)
- Language detection
- Single Gemini call for all text content

**Stage 2: Image Moderation (~0.02 NOK per image)**
- Only runs if Stage 1 passes
- Skip images generated by our own "cheap tier" (already safe)
- Use Gemini Vision API for user-uploaded images
- Check for: NSFW, violence, inappropriate content

**Stage 3: User Review**
- Preview with suggested content warnings
- User can: Accept & Publish, Edit & Re-check, Cancel
- Max 3 moderation attempts per publish (prevents cost abuse)

#### Cost Breakdown:
```
Text-only deck:        0.01 NOK
8-card deck + images:  0.01 + (8 × 0.02) = 0.17 NOK
20-card deck + images: 0.01 + (20 × 0.02) = 0.41 NOK
```

### 4. Content Taxonomy

**Categories:**
- RPG (D&D, Pathfinder, WFRP, generic, etc.)
- Educational
- Recipes
- Flashcards
- Worldbuilding
- Creative/Reference

**Themes:**
- Fantasy, Sci-Fi, Cyberpunk, Horror
- Historical, Modern, Post-Apocalyptic
- Comedy, Dark, Whimsical

**Content Types:**
- Characters, Locations, Items, Spells
- Encounters, Plot Hooks, Lore, Mechanics

**Quality Flags:**
- high-effort, original-art, creative, detailed
- ai-generated, generic (for transparency)

### 5. Moderation Policy (RPG-Friendly)

**✅ ALLOWED:**
- Fantasy violence (swords, combat)
- Moderate sensuality (barbarians, seductive characters)
- Horror/scary themes (Lovecraftian, gothic)
- Alcohol/fantasy drugs

**⚠️ WARNED (tagged, still published):**
- Sexual content → `mature_sexual`
- Moderate violence → `mature_violent`
- Disturbing themes → `mature_disturbing`

**❌ BLOCKED:**
- Illegal content (CSAM, terrorism)
- Hate speech
- Extreme graphic violence
- Doxxing/harassment

### 6. Publishing Flow

```
User clicks "Publish Deck"
  ↓
Upload images to Vercel Blob
  ↓
Stage 1: Analyze text content
  ├─ ✅ Safe → Continue
  ├─ ⚠️  Warnings → Show preview with tags
  └─ ❌ Blocked → Reject with reason
  ↓
Stage 2: Analyze images (if any user-uploaded)
  ├─ Skip our AI-generated images (already safe)
  └─ Check user images with Vision API
  ↓
Show preview with:
  - Suggested content warnings
  - Category and tags
  - Quality score
  - [Accept & Publish] [Edit & Re-check] [Cancel]
  ↓
Save to Supabase with:
  - Hosted image URLs
  - Content warnings
  - Categories and tags
  - Quality score
  - AI analysis metadata
```

### 7. Database Updates

```sql
-- Add to published_decks table
ALTER TABLE published_decks ADD COLUMN content_warnings TEXT[];
ALTER TABLE published_decks ADD COLUMN category TEXT;
ALTER TABLE published_decks ADD COLUMN tags TEXT[];
ALTER TABLE published_decks ADD COLUMN themes TEXT[];
ALTER TABLE published_decks ADD COLUMN language TEXT DEFAULT 'en';
ALTER TABLE published_decks ADD COLUMN ai_quality_score INTEGER;
ALTER TABLE published_decks ADD COLUMN is_editors_pick BOOLEAN DEFAULT FALSE;
ALTER TABLE published_decks ADD COLUMN estimated_age TEXT;
ALTER TABLE published_decks ADD COLUMN moderation_checks INTEGER DEFAULT 0;
ALTER TABLE published_decks ADD COLUMN analysis JSONB;
```

### 8. API Routes

```
POST /api/auth/signup          - Create account
POST /api/auth/login           - Login
GET  /api/auth/session         - Check session

POST /api/deck/publish         - Publish deck (with moderation)
POST /api/deck/moderate        - Re-check content (after edits)
GET  /api/deck/[id]            - Fetch published deck (already exists)

POST /api/images/upload        - Upload image to Vercel Blob
```

## Implementation Checklist

### Week 1: Auth & Infrastructure
- [ ] Set up Supabase Auth
- [ ] Add sign up / sign in UI
- [ ] Session management
- [ ] Update Header with auth state
- [ ] Protected API routes

### Week 2: Image Hosting
- [ ] Set up Vercel Blob storage
- [ ] Image upload API route
- [ ] Automatic upload on publish
- [ ] Track which images are AI-generated (skip moderation)

### Week 3: Content Moderation
- [ ] Implement text moderation (Stage 1)
- [ ] Implement image moderation (Stage 2)
- [ ] Create publish preview UI
- [ ] Add moderation attempt limits (3 max)
- [ ] Store analysis results

### Week 4: Publishing Flow
- [ ] Complete publish workflow
- [ ] Test with various content types
- [ ] Add content warning badges
- [ ] Prepare for gallery (Phase 1B+)

## Success Metrics
- ✅ Publishing takes < 30 seconds (with images)
- ✅ Moderation cost < 0.50 NOK per deck
- ✅ < 5% false positive blocks
- ✅ 90%+ of RPG content allowed with appropriate tags

## What's NOT in Phase 1B
- ❌ Payment/credits (that's Phase 1C)
- ❌ AI generation server-side (Phase 1C)
- ❌ User ratings (Phase 2)
- ❌ Remixes tracking (Phase 2)
- ❌ Gallery page (Phase 1B+ / mini-phase)

## Next: Phase 1C
Once Phase 1B is complete:
- Move AI generation server-side
- Implement credit system
- Add Lemon Squeezy payments
- Watermarking for "cheap tier"
